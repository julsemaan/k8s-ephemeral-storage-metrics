name: release-tag

on:
  push:
    tags:
      - "*"

permissions:
  contents: read

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.prepare.outputs.version }}
      is_prerelease: ${{ steps.prepare.outputs.is_prerelease }}
    steps:
      - id: prepare
        shell: bash
        run: |
          set -euo pipefail

          VERSION="${GITHUB_REF_NAME}"
          if [[ ! "${VERSION}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-rc[0-9]+)?$ ]]; then
            echo "Unsupported tag format: ${VERSION}"
            echo "Expected one of: X.Y.Z or X.Y.Z-rcNN"
            exit 1
          fi

          IS_PRERELEASE="false"
          if [[ "${VERSION}" == *"-rc"* ]]; then
            IS_PRERELEASE="true"
          fi

          {
            echo "version=${VERSION}"
            echo "is_prerelease=${IS_PRERELEASE}"
          } >> "${GITHUB_OUTPUT}"

  publish-image:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-qemu-action@v3

      - uses: docker/setup-buildx-action@v3

      - name: Resolve image repo
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          DOCKER_IMAGE_REPO: ${{ vars.DOCKER_IMAGE_REPO }}
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${DOCKER_USERNAME:-}" ]]; then
            echo "DOCKER_USERNAME secret is required"
            exit 1
          fi
          if [[ -z "${DOCKER_PASSWORD:-}" ]]; then
            echo "DOCKER_PASSWORD secret is required"
            exit 1
          fi

          IMAGE_REPO="${DOCKER_IMAGE_REPO:-}"
          IMAGE_REPO="$(echo "${IMAGE_REPO}" | xargs)"
          if [[ -z "${IMAGE_REPO}" ]]; then
            IMAGE_REPO="docker.io/${DOCKER_USERNAME}/k8s-ephemeral-storage-metrics"
          fi
          IMAGE_REPO="${IMAGE_REPO%/}"

          if [[ -z "${IMAGE_REPO}" || "${IMAGE_REPO}" == *[[:space:]]* ]]; then
            echo "Invalid resolved image repo: '${IMAGE_REPO}'"
            echo "Set DOCKER_IMAGE_REPO to a non-empty repo (example: docker.io/<user>/k8s-ephemeral-storage-metrics)"
            exit 1
          fi

          echo "IMAGE_REPO=${IMAGE_REPO}" >> "${GITHUB_ENV}"

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push prerelease image
        if: needs.prepare.outputs.is_prerelease == 'true'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ env.IMAGE_REPO }}:${{ needs.prepare.outputs.version }}
          labels: |
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.version=${{ needs.prepare.outputs.version }}

      - name: Build and push stable image
        if: needs.prepare.outputs.is_prerelease == 'false'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.IMAGE_REPO }}:${{ needs.prepare.outputs.version }}
            ${{ env.IMAGE_REPO }}:latest
          labels: |
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.version=${{ needs.prepare.outputs.version }}
