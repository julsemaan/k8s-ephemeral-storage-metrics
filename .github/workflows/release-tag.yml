name: release-tag

on:
  push:
    tags:
      - "*"

permissions:
  contents: read
  packages: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.prepare.outputs.version }}
      is_prerelease: ${{ steps.prepare.outputs.is_prerelease }}
      registry_target: ${{ steps.prepare.outputs.registry_target }}
      image_repo: ${{ steps.prepare.outputs.image_repo }}
      helm_oci_repo: ${{ steps.prepare.outputs.helm_oci_repo }}
      registry_host: ${{ steps.prepare.outputs.registry_host }}
    steps:
      - id: prepare
        env:
          REGISTRY_TARGET: ${{ vars.REGISTRY_TARGET }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        shell: bash
        run: |
          set -euo pipefail

          VERSION="${GITHUB_REF_NAME}"
          if [[ ! "${VERSION}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-rc[0-9]+)?$ ]]; then
            echo "Unsupported tag format: ${VERSION}"
            echo "Expected one of: X.Y.Z or X.Y.Z-rcNN"
            exit 1
          fi

          REGISTRY_TARGET_LOWER="$(echo "${REGISTRY_TARGET:-}" | tr '[:upper:]' '[:lower:]')"
          if [[ "${REGISTRY_TARGET_LOWER}" != "ghcr" && "${REGISTRY_TARGET_LOWER}" != "dockerhub" ]]; then
            echo "vars.REGISTRY_TARGET must be 'ghcr' or 'dockerhub'. Current value: '${REGISTRY_TARGET:-<empty>}'"
            exit 1
          fi

          IS_PRERELEASE="false"
          if [[ "${VERSION}" == *"-rc"* ]]; then
            IS_PRERELEASE="true"
          fi

          if [[ "${REGISTRY_TARGET_LOWER}" == "ghcr" ]]; then
            REGISTRY_HOST="ghcr.io"
            IMAGE_REPO="ghcr.io/${GITHUB_REPOSITORY_OWNER}/k8s-ephemeral-storage-metrics"
            HELM_OCI_REPO="oci://ghcr.io/${GITHUB_REPOSITORY_OWNER}/charts"
          else
            if [[ -z "${DOCKERHUB_USERNAME:-}" ]]; then
              echo "DOCKERHUB_USERNAME secret is required when REGISTRY_TARGET=dockerhub"
              exit 1
            fi

            REGISTRY_HOST="registry-1.docker.io"
            IMAGE_REPO="docker.io/${DOCKERHUB_USERNAME}/k8s-ephemeral-storage-metrics"
            HELM_OCI_REPO="oci://registry-1.docker.io/${DOCKERHUB_USERNAME}/charts"
          fi

          {
            echo "version=${VERSION}"
            echo "is_prerelease=${IS_PRERELEASE}"
            echo "registry_target=${REGISTRY_TARGET_LOWER}"
            echo "registry_host=${REGISTRY_HOST}"
            echo "image_repo=${IMAGE_REPO}"
            echo "helm_oci_repo=${HELM_OCI_REPO}"
          } >> "${GITHUB_OUTPUT}"

  publish-image:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-qemu-action@v3

      - uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        if: needs.prepare.outputs.registry_target == 'ghcr'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        if: needs.prepare.outputs.registry_target == 'dockerhub'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push prerelease image
        if: needs.prepare.outputs.is_prerelease == 'true'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ needs.prepare.outputs.image_repo }}:${{ needs.prepare.outputs.version }}
          labels: |
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.version=${{ needs.prepare.outputs.version }}

      - name: Build and push stable image
        if: needs.prepare.outputs.is_prerelease == 'false'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ needs.prepare.outputs.image_repo }}:${{ needs.prepare.outputs.version }}
            ${{ needs.prepare.outputs.image_repo }}:latest
          labels: |
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.version=${{ needs.prepare.outputs.version }}

  publish-helm-oci:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: azure/setup-helm@v4

      - name: Prepare and package chart
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
          IMAGE_REPO: ${{ needs.prepare.outputs.image_repo }}
        shell: bash
        run: |
          set -euo pipefail
          sed -i -E "s/^version:.*/version: ${VERSION}/" chart/Chart.yaml
          sed -i -E "s/^appVersion:.*/appVersion: ${VERSION}/" chart/Chart.yaml
          sed -i -E "s|^  repository:.*|  repository: ${IMAGE_REPO}|" chart/values.yaml
          sed -i -E "s/^  tag:.*/  tag: ${VERSION}/" chart/values.yaml

          helm lint ./chart
          mkdir -p dist
          helm package ./chart --version "${VERSION}" --app-version "${VERSION}" --destination dist

      - name: Login to GHCR Helm registry
        if: needs.prepare.outputs.registry_target == 'ghcr'
        shell: bash
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io \
            --username "${{ github.actor }}" \
            --password-stdin

      - name: Login to Docker Hub Helm registry
        if: needs.prepare.outputs.registry_target == 'dockerhub'
        shell: bash
        run: |
          if [[ -z "${{ secrets.DOCKERHUB_USERNAME }}" || -z "${{ secrets.DOCKERHUB_TOKEN }}" ]]; then
            echo "DOCKERHUB_USERNAME and DOCKERHUB_TOKEN are required when REGISTRY_TARGET=dockerhub"
            exit 1
          fi
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | helm registry login registry-1.docker.io \
            --username "${{ secrets.DOCKERHUB_USERNAME }}" \
            --password-stdin

      - name: Push chart to OCI registry
        env:
          HELM_OCI_REPO: ${{ needs.prepare.outputs.helm_oci_repo }}
        shell: bash
        run: |
          set -euo pipefail
          CHART_TGZ="$(ls dist/k8s-ephemeral-storage-metrics-*.tgz)"
          helm push "${CHART_TGZ}" "${HELM_OCI_REPO}"
